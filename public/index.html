<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šäººäº”å­æ£‹</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container { display: flex; gap: 20px; max-width: 1400px; width: 100%; }
    .game-panel {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      flex: 1;
      min-width: 0;
    }
    
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 700px;
      overflow-y: auto;
    }
    
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    
    .rules { background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .rules h3 { margin-bottom: 12px; color: #333; }
    .rules ul { padding-left: 20px; color: #666; }
    .rules li { margin-bottom: 6px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    input[type="text"]:focus { outline: none; border-color: #667eea; }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .btn-danger { background: linear-gradient(135deg, #eb3349, #f45c43); color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .color-picker { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.3); }
    .color-option.disabled { opacity: 0.3; cursor: not-allowed; }
    
    .room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .room-item:hover { background: #e9ecef; }
    .room-id { font-weight: bold; font-family: monospace; font-size: 16px; color: #667eea; }
    .room-count { color: #666; font-size: 14px; }
    .join-btn-small { padding: 6px 12px; font-size: 12px; background: #667eea; color: white; border: none; border-radius: 4px; }
    
    .game-board {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      gap: 1px;
      background: #d4a574;
      padding: 10px;
      border-radius: 8px;
      margin: 0 auto 20px;
      max-width: 500px;
    }
    
    .cell { aspect-ratio: 1; background: #e8c39e; border-radius: 2px; cursor: pointer; }
    .cell:hover { background: #d4a574; }
    
    .piece {
      width: 85%;
      height: 85%;
      border-radius: 50%;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .piece.black { background: radial-gradient(circle at 30% 30%, #666, #000); }
    .piece.white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); }
    .piece.red { background: radial-gradient(circle at 30% 30%, #ff6b6b, #c00); }
    .piece.blue { background: radial-gradient(circle at 30% 30%, #74b9ff, #0984e3); }
    .piece.green { background: radial-gradient(circle at 30% 30%, #55efc4, #00b894); }
    .piece.yellow { background: radial-gradient(circle at 30% 30%, #ffeaa7, #fdcb6e); }
    .piece.purple { background: radial-gradient(circle at 30% 30%, #a29bfe, #6c5ce7); }
    .piece.orange { background: radial-gradient(circle at 30% 30%, #fab1a0, #e17055); }
    .piece.pink { background: radial-gradient(circle at 30% 30%, #fd79a8, #e84393); }
    .piece.cyan { background: radial-gradient(circle at 30% 30%, #81ecec, #00cec9); }
    
    .player-list { background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    
    .player-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .player-item:last-child { border-bottom: none; }
    
    .player-order {
      width: 24px;
      height: 24px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      margin-right: 10px;
    }
    .player-name { flex: 1; font-weight: 600; }
    .player-color { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; }
    
    .turn-indicator {
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: bold;
    }
    .turn-indicator.waiting { background: #6c757d; }
    .turn-indicator.paused { background: #f39c12; }
    
    .chat-container { height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .chat-message { margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; background: white; }
    .chat-message.system { background: #e9ecef; color: #666; font-size: 14px; text-align: center; }
    
    .chat-header { font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .chat-color-dot { width: 12px; height: 12px; border-radius: 50%; }
    
    .chat-input { display: flex; gap: 8px; }
    .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .btn-chat { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; }
    .modal-content h2 { margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .modal-buttons .btn { margin-bottom: 0; }
    
    .screen { display: none; }
    .screen.active { display: block; }
    
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .room-id-badge { background: #667eea; color: white; padding: 8px 16px; border-radius: 8px; font-family: monospace; font-size: 18px; }
    
    .my-piece-info { text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 16px; }
    .my-piece-color { display: inline-block; width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin: 0 8px; border: 2px solid #ddd; }
    
    .action-buttons { display: flex; gap: 10px; margin-top: 16px; }
    .action-buttons .btn { margin-bottom: 0; flex: 1; }
    
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; max-height: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="game-panel">
      <h1>å¤šäººäº”å­æ£‹</h1>
      
      <div id="menuScreen" class="screen active">
        <div class="rules">
          <h3>æ¸¸æˆè§„åˆ™</h3>
          <ul>
            <li>3-10äººè½®æµä¸‹æ£‹</li>
            <li>è¿æˆ5å­è·èƒœ</li>
            <li>æŒ‰åŠ å…¥é¡ºåºä¸‹æ£‹</li>
            <li>å¯ä»¥è‡ªç”±é€‰æ‹©æ£‹å­é¢œè‰²</li>
          </ul>
        </div>
        
        <div class="form-group">
          <label>ä½ çš„æ˜µç§°</label>
          <input type="text" id="playerName" placeholder="è¾“å…¥æ˜µç§°" maxlength="20">
        </div>
        
        <button class="btn btn-success" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
      </div>
      
      <div id="roomScreen" class="screen">
        <div class="room-header">
          <span class="room-id-badge" id="roomIdDisplay">ROOM</span>
          <button class="btn btn-warning" onclick="leaveCurrentRoom()" style="width: auto; padding: 8px 16px;">ç¦»å¼€</button>
        </div>
        
        <div class="player-list">
          <h4 style="margin-bottom: 12px;">ç©å®¶åˆ—è¡¨ <span id="playerCount">(0/10)</span></h4>
          <div id="playerList"></div>
        </div>
        
        <div class="rules">
          <h4 style="margin-bottom: 12px;">é€‰æ‹©ä½ çš„æ£‹å­é¢œè‰²</h4>
          <div class="color-picker" id="colorPicker"></div>
        </div>
        
        <button class="btn btn-primary" id="startBtn" onclick="startGame()" style="display:none;">å¼€å§‹æ¸¸æˆ</button>
      </div>
      
      <div id="gameScreen" class="screen">
        <div class="room-header">
          <span class="room-id-badge" id="gameRoomIdDisplay">ROOM</span>
          <div id="currentTurn" class="turn-indicator waiting">ç­‰å¾…å¼€å§‹...</div>
        </div>
        
        <div class="game-board" id="gameBoard"></div>
        
        <div id="myPieceInfo" class="my-piece-info">
          <span>ä½ çš„æ£‹å­ï¼š</span>
          <span id="myPieceColor" class="my-piece-color"></span>
          <span id="myPieceName"></span>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-warning" onclick="leaveGameToHome()">è¿”å›ä¸»é¡µ</button>
        </div>
      </div>
    </div>
    
    <div class="sidebar">
      <div id="homeSidebar">
        <h3 style="margin-bottom: 16px;">åŠ å…¥æˆ¿é—´</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" id="joinRoomInput" placeholder="è¾“å…¥æˆ¿é—´å·" maxlength="6" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px;text-transform:uppercase;letter-spacing:2px;text-align:center;">
          <button class="btn btn-primary" onclick="joinByInput()" style="width:auto;padding:10px 16px;">åŠ å…¥</button>
        </div>
        
        <h4 style="margin-bottom: 12px;">å…¬å¼€æˆ¿é—´</h4>
        <div id="roomList" class="room-list">
          <div style="text-align:center;color:#999;padding:20px;">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div id="gameSidebar" style="display:none;">
        <h3 style="margin-bottom: 16px;">èŠå¤©</h3>
        <div class="chat-container" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="100" onkeypress="if(event.key==='Enter')sendChat()">
          <button class="btn-chat" onclick="sendChat()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- è·èƒœå¼¹çª— -->
  <div id="winnerModal" class="modal">
    <div class="modal-content">
      <h2>æ¸¸æˆç»“æŸï¼</h2>
      <div id="winnerInfo"></div>
      <button class="btn btn-success" onclick="closeModal(); restartGame();" style="margin-top:20px;">å†æ¥ä¸€å±€</button>
      <button class="btn btn-warning" onclick="closeModal()">è¿”å›æˆ¿é—´</button>
    </div>
  </div>
  
  <!-- æˆ¿ä¸»ç¡®è®¤å¼¹çª— -->
  <div id="ownerConfirmModal" class="modal">
    <div class="modal-content">
      <h2>ç©å®¶ç¦»çº¿</h2>
      <p id="ownerConfirmMsg" style="margin: 20px 0; color: #666;">ç©å®¶ XXX ç¦»çº¿äº†ï¼Œæ˜¯å¦ç­‰å¾…é‡è¿ï¼Ÿ</p>
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="ownerContinueWaiting()">ç»§ç»­ç­‰å¾…</button>
        <button class="btn btn-danger" onclick="ownerSkipPlayer()">ç§»é™¤ç©å®¶</button>
      </div>
    </div>
  </div>

  <script>
    const PLAYER_ROLES = ['é»‘æ£‹', 'ç™½æ£‹', 'çº¢æ£‹', 'è“æ£‹', 'ç»¿æ£‹', 'é»„æ£‹', 'ç´«æ£‹', 'æ©™æ£‹', 'ç²‰æ£‹', 'é’æ£‹'];
    const PLAYER_COLORS = ['#000000', '#FFFFFF', '#FF0000', '#0984e3', '#00b894', '#fdcb6e', '#6c5ce7', '#e17055', '#e84393', '#00cec9'];
    const PIECE_CLASSES = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'cyan'];
    
    let ws = null;
    let myOrderId = null;
    let myColorId = null;
    let ownerOrderId = null;
    let currentRoomId = null;
    let players = [];
    let currentTurn = null;
    let waitingReconnect = false;
    let pendingOfflineOrderId = null;
    
    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + window.location.host);
      
      ws.onopen = () => {
        refreshRoomList();
      };
      
      ws.onmessage = (event) => {
        handleMessage(JSON.parse(event.data));
      };
      
      ws.onclose = () => {
        setTimeout(connect, 3000);
      };
    }
    
    function safeSend(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
      }
    }
    
    function handleMessage(msg) {
      switch (msg.type) {
        case 'created':
        case 'joined':
          currentRoomId = msg.roomId;
          myOrderId = msg.orderId;
          myColorId = msg.colorId;
          ownerOrderId = msg.ownerOrderId;
          players = msg.players;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          localStorage.setItem('gomoku_colorId', msg.colorId);
          switchScreen('roomScreen');
          document.getElementById('roomIdDisplay').textContent = msg.roomId;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'none';
          clearChat();
          updatePlayerList();
          updateColorPicker();
          setTimeout(refreshRoomList, 100);
          break;
          
        case 'playerJoined':
          players = msg.players;
          // ä¸æ›´æ–°ownerOrderIdï¼Œç­‰å¾…ownerChangedæ¶ˆæ¯
          updatePlayerList();
          updateColorPicker();
          break;
          
        case 'playerLeft':
          players = msg.players;
          // ä¸æ›´æ–°ownerOrderIdï¼Œç­‰å¾…ownerChangedæ¶ˆæ¯
          updatePlayerList();
          updateColorPicker();
          addSystemMessage(msg.playerName + ' ç¦»å¼€äº†æˆ¿é—´');
          break;
          
        case 'colorChanged':
          players = msg.players;
          updatePlayerList();
          updateColorPicker();
          break;
          
        case 'ownerChanged':
          ownerOrderId = msg.newOwnerOrderId;
          addSystemMessage('æ–°æˆ¿ä¸»: ' + msg.newOwnerName);
          updatePlayerList();
          
          // å¦‚æœæœ‰ç¦»çº¿ä¿¡æ¯ï¼Œæ–°æˆ¿ä¸»æ˜¾ç¤ºç¡®è®¤å¼¹çª—
          if (msg.offlinePlayerName && myOrderId === ownerOrderId) {
            pendingOfflineOrderId = msg.offlineOrderId;
            document.getElementById('ownerConfirmMsg').textContent = 'ç©å®¶ ' + msg.offlinePlayerName + ' ç¦»çº¿äº†ï¼Œæ˜¯å¦ç­‰å¾…é‡è¿ï¼Ÿ';
            document.getElementById('ownerConfirmModal').style.display = 'flex';
          }
          break;
          
        case 'gameStart':
          switchScreen('gameScreen');
          document.getElementById('gameRoomIdDisplay').textContent = currentRoomId;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'block';
          initBoard();
          currentTurn = 0;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          clearChat();
          players = msg.players;
          ownerOrderId = msg.ownerOrderId !== undefined ? msg.ownerOrderId : players[0]?.orderId;
          updateGame();
          updatePlayerList();
          addSystemMessage('æ¸¸æˆå¼€å§‹ï¼æŒ‰åŠ å…¥é¡ºåºä¸‹æ£‹');
          break;
          
        case 'move':
          placePiece(msg.row, msg.col, msg.colorId);
          currentTurn = msg.currentPlayer;
          updateTurn();
          if (msg.gameOver) {
            showWinner(msg.winner);
          }
          break;
          
        case 'playerOffline':
          waitingReconnect = true;
          addSystemMessage(msg.playerName + ' ç¦»çº¿äº†');
          updateTurn();
          break;
          
        case 'ownerConfirm':
          // ä¿ç•™ä½œä¸ºåå¤‡ï¼šéæˆ¿ä¸»ç¦»çº¿æ—¶çš„å¤„ç†
          if (myOrderId === ownerOrderId) {
            pendingOfflineOrderId = msg.orderId;
            document.getElementById('ownerConfirmMsg').textContent = 'ç©å®¶ ' + msg.playerName + ' ç¦»çº¿äº†ï¼Œæ˜¯å¦ç­‰å¾…é‡è¿ï¼Ÿ';
            document.getElementById('ownerConfirmModal').style.display = 'flex';
          }
          break;
        
        case 'playerReconnected':
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          players = msg.players;
          ownerOrderId = msg.ownerOrderId !== undefined ? msg.ownerOrderId : players[0]?.orderId;
          addSystemMessage(msg.playerName + ' å·²é‡è¿ï¼');
          updatePlayerList();
          updateTurn();
          break;
          
        case 'gameResumed':
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          addSystemMessage(msg.message);
          updateTurn();
          break;
          
        case 'playerRemoved':
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          players = msg.players;
          currentTurn = msg.currentPlayer;
          ownerOrderId = players[0]?.orderId || 0;
          addSystemMessage(msg.playerName + ' å·²è¢«ç§»é™¤');
          updatePlayerList();
          updateTurn();
          break;
          
        case 'rejoined':
          currentRoomId = msg.roomId;
          myOrderId = msg.orderId;
          myColorId = msg.colorId;
          currentTurn = msg.currentPlayer;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          players = msg.players;
          switchScreen('gameScreen');
          document.getElementById('gameRoomIdDisplay').textContent = msg.roomId;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'block';
          clearChat();
          
          // æ¢å¤æ£‹ç›˜
          initBoard();
          for (let i = 0; i < 15; i++) {
            for (let j = 0; j < 15; j++) {
              if (msg.board[i][j] !== 0) {
                const colorId = msg.board[i][j] - 1;
                placePiece(i, j, colorId);
              }
            }
          }
          
          updateGame();
          updateTurn();
          addSystemMessage('é‡è¿æˆåŠŸï¼');
          break;
          
        case 'restart':
          initBoard();
          currentTurn = 0;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          clearChat();
          updateTurn();
          addSystemMessage('æ¸¸æˆé‡æ–°å¼€å§‹ï¼');
          break;
          
        case 'rooms':
          renderRoomList(msg.rooms);
          break;
          
        case 'chat':
          addChatMessage(msg);
          break;
          
        case 'error':
          alert(msg.message);
          break;
      }
    }
    
    function switchScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }
    
    function clearChat() {
      document.getElementById('chatMessages').innerHTML = '';
    }
    
    function createRoom() {
      const playerName = document.getElementById('playerName').value.trim() || 'ç©å®¶1';
      safeSend({ type: 'create', playerName });
    }
    
    function joinRoom(roomId) {
      let playerName = document.getElementById('playerName').value.trim();
      if (!playerName) {
        playerName = localStorage.getItem('gomoku_playerName') || 'ç©å®¶' + Date.now() % 1000;
      }
      const savedColorId = parseInt(localStorage.getItem('gomoku_colorId') || '0');
      safeSend({ type: 'join', roomId, playerName, colorId: savedColorId });
    }
    
    function joinByInput() {
      const input = document.getElementById('joinRoomInput');
      const roomId = input.value.trim().toUpperCase();
      if (roomId.length < 4) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·');
        return;
      }
      let playerName = document.getElementById('playerName').value.trim();
      if (!playerName) {
        playerName = localStorage.getItem('gomoku_playerName') || 'ç©å®¶' + Date.now() % 1000;
      }
      const savedColorId = parseInt(localStorage.getItem('gomoku_colorId') || '0');
      safeSend({ type: 'join', roomId, playerName, colorId: savedColorId });
      input.value = '';
    }
    
    function selectColor(colorId) {
      if (players.some(p => p.colorId === colorId)) return;
      myColorId = colorId;
      localStorage.setItem('gomoku_colorId', colorId);
      safeSend({ type: 'selectColor', orderId: myOrderId, colorId });
    }
    
    function updatePlayerList() {
      document.getElementById('playerCount').textContent = '(' + players.length + '/10)';
      const list = document.getElementById('playerList');
      list.innerHTML = players.map((p, idx) => {
        const isOwner = p.orderId === ownerOrderId;
        const isMe = p.orderId === myOrderId;
        return '<div class="player-item">' +
          '<div class="player-order">' + (idx + 1) + '</div>' +
          '<div class="player-name">' + p.name + (isOwner ? ' ğŸ‘‘' : '') + (isMe ? ' (ä½ )' : '') + '</div>' +
          '<div class="player-color" style="background:' + p.color + '"></div></div>';
      }).join('');
      
      const startBtn = document.getElementById('startBtn');
      if (myOrderId === ownerOrderId) {
        startBtn.style.display = 'block';
        startBtn.disabled = players.length < 2;
        startBtn.textContent = players.length < 2 ? 'å¼€å§‹æ¸¸æˆ (è¿˜éœ€ ' + (2 - players.length) + ' äºº)' : 'å¼€å§‹æ¸¸æˆ';
      } else {
        startBtn.style.display = 'none';
      }
    }
    
    function updateColorPicker() {
      const takenColors = players.map(p => p.colorId);
      const picker = document.getElementById('colorPicker');
      picker.innerHTML = PIECE_CLASSES.map((cls, idx) => {
        const isTaken = takenColors.includes(idx);
        const isSelected = idx === myColorId;
        const action = isTaken ? '' : 'onclick="selectColor(' + idx + ')"';
        return '<div class="color-option ' + (isSelected ? 'selected' : '') + ' ' + (isTaken ? 'disabled' : '') + '" ' +
          'style="background:' + PLAYER_COLORS[idx] + '" ' + action + '></div>';
      }).join('');
    }
    
    function startGame() {
      safeSend({ type: 'start' });
    }
    
    function initBoard() {
      const board = document.getElementById('gameBoard');
      board.innerHTML = '';
      for (let i = 0; i < 15; i++) {
        for (let j = 0; j < 15; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = i;
          cell.dataset.col = j;
          cell.onclick = () => makeMove(i, j);
          board.appendChild(cell);
        }
      }
    }
    
    function makeMove(row, col) {
      if (myOrderId !== currentTurn) return;
      if (waitingReconnect) return;
      const cell = document.querySelector('.cell[data-row="' + row + '"][data-col="' + col + '"]');
      if (cell && cell.querySelector('.piece')) return;
      safeSend({ type: 'move', orderId: myOrderId, row, col });
    }
    
    function placePiece(row, col, colorId) {
      const cell = document.querySelector('.cell[data-row="' + row + '"][data-col="' + col + '"]');
      if (cell && !cell.querySelector('.piece')) {
        const piece = document.createElement('div');
        piece.className = 'piece ' + PIECE_CLASSES[colorId];
        cell.appendChild(piece);
      }
    }
    
    function updateGame() {
      const me = players.find(p => p.orderId === myOrderId);
      if (me) {
        document.getElementById('myPieceColor').style.background = me.color;
        document.getElementById('myPieceName').textContent = me.role;
      }
      updateTurn();
    }
    
    function updateTurn() {
      const turnIndicator = document.getElementById('currentTurn');
      
      if (waitingReconnect) {
        turnIndicator.className = 'turn-indicator paused';
        turnIndicator.innerHTML = 'â¸ ç­‰å¾…æˆ¿ä¸»å¤„ç†...';
        return;
      }
      
      const player = players.find(p => p.orderId === currentTurn);
      
      if (player) {
        const isMyTurn = player.orderId === myOrderId;
        turnIndicator.className = isMyTurn ? 'turn-indicator' : 'turn-indicator waiting';
        turnIndicator.innerHTML = isMyTurn 
          ? 'è½®åˆ°ä½ äº†ï¼(' + player.role + ')'
          : 'ç­‰å¾… ' + player.name + ' ä¸‹æ£‹ (' + player.role + ')';
      } else {
        // å¦‚æœæ‰¾ä¸åˆ°ç©å®¶ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        turnIndicator.className = 'turn-indicator waiting';
        turnIndicator.innerHTML = 'ç­‰å¾…æ¸¸æˆä¸­...';
      }
    }
    
    function showWinner(winnerOrderId) {
      const winner = players.find(p => p.orderId === winnerOrderId);
      document.getElementById('winnerInfo').innerHTML = '<p style="font-size:24px;margin-bottom:10px;">ğŸ† ' + (winner ? winner.name : 'æœªçŸ¥') + ' è·èƒœï¼</p><p>(' + (winner ? winner.role : '') + ')</p>';
      document.getElementById('winnerModal').style.display = 'flex';
    }
    
    function restartGame() {
      closeModal();
      safeSend({ type: 'restart' });
    }
    
    function closeModal() {
      document.getElementById('winnerModal').style.display = 'none';
      document.getElementById('ownerConfirmModal').style.display = 'none';
    }
    
    function ownerContinueWaiting() {
      safeSend({ type: 'ownerDecision', orderId: myOrderId, continueWaiting: true });
      document.getElementById('ownerConfirmModal').style.display = 'none';
    }
    
    function ownerSkipPlayer() {
      safeSend({ type: 'ownerDecision', orderId: myOrderId, continueWaiting: false });
      document.getElementById('ownerConfirmModal').style.display = 'none';
    }
    
    function leaveCurrentRoom() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leave' }));
      }
      currentRoomId = null;
      myOrderId = null;
      ownerOrderId = null;
      players = [];
      waitingReconnect = false;
      pendingOfflineOrderId = null;
      switchScreen('menuScreen');
      document.getElementById('homeSidebar').style.display = 'block';
      document.getElementById('gameSidebar').style.display = 'none';
      refreshRoomList();
    }
    
    function leaveGameToHome() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leave' }));
      }
      currentRoomId = null;
      myOrderId = null;
      ownerOrderId = null;
      players = [];
      waitingReconnect = false;
      pendingOfflineOrderId = null;
      switchScreen('menuScreen');
      document.getElementById('homeSidebar').style.display = 'block';
      document.getElementById('gameSidebar').style.display = 'none';
      refreshRoomList();
    }
    
    function refreshRoomList() {
      safeSend({ type: 'getRooms' });
    }
    
    function renderRoomList(rooms) {
      const list = document.getElementById('roomList');
      if (!rooms || rooms.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æˆ¿é—´</div>';
        return;
      }
      list.innerHTML = rooms.map(r => 
        '<div class="room-item" onclick="joinRoom(\'' + r.id + '\')">' +
          '<div><div class="room-id">' + r.id + '</div><div class="room-count">' + r.playerCount + ' äºº</div></div>' +
          '<button class="join-btn-small">åŠ å…¥</button></div>'
      ).join('');
    }
    
    function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      safeSend({ type: 'chat', message });
      input.value = '';
    }
    
    function addChatMessage(msg) {
      const container = document.getElementById('chatMessages');
      const player = players.find(p => p.orderId === msg.orderId);
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = '<div class="chat-header"><span class="chat-color-dot" style="background:' + (player ? player.color : '#999') + '"></span><span>' + (msg.playerName || 'ç©å®¶') + '</span></div><div>' + msg.message + '</div>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    function addSystemMessage(message) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message system';
      div.textContent = message;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    window.onload = function() {
      connect();
      initBoard();
      setInterval(refreshRoomList, 10000);
    };
  </script>
</body>
</html>
